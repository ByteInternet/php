From 1b742a2e9f73c3ae57fbe7939932e22b619ce65e Mon Sep 17 00:00:00 2001
From: manuel <manuel@mausz.at>
Date: Fri, 26 Sep 2014 18:11:10 +0200
Subject: [PATCH] Opcache: Fix segfault while pre-evaluating a disabled
 function

---
 Zend/zend_API.c                 | 13 +++++++++++--
 ext/opcache/tests/bug68104.phpt | 13 +++++++++++++
 2 files changed, 24 insertions(+), 2 deletions(-)
 create mode 100644 ext/opcache/tests/bug68104.phpt

--- php5.orig/Zend/zend_API.c
+++ php5/Zend/zend_API.c
@@ -2642,11 +2642,20 @@ static zend_function_entry disabled_func
 
 ZEND_API int zend_disable_function(char *function_name, uint function_name_length TSRMLS_DC) /* {{{ */
 {
-	if (zend_hash_del(CG(function_table), function_name, function_name_length+1)==FAILURE) {
+	zend_internal_function *func;
+	int retval;
+
+	if (zend_hash_find(CG(function_table), function_name, function_name_length+1, (void *)&func) == FAILURE) {
 		return FAILURE;
 	}
+
+	zend_hash_del(CG(function_table), function_name, function_name_length+1);
+
+	EG(current_module) = func->module;
 	disabled_function[0].fname = function_name;
-	return zend_register_functions(NULL, disabled_function, CG(function_table), MODULE_PERSISTENT TSRMLS_CC);
+	retval = zend_register_functions(NULL, disabled_function, CG(function_table), MODULE_PERSISTENT TSRMLS_CC);
+	EG(current_module) = NULL;
+	return retval;
 }
 /* }}} */
 
--- /dev/null
+++ php5/ext/opcache/tests/bug68104.phpt
@@ -0,0 +1,13 @@
+--TEST--
+Bug #68104 (Segfault while pre-evaluating a disabled function)
+--INI--
+opcache.enable=1
+opcache.enable_cli=1
+disable_functions=dl
+--SKIPIF--
+<?php require_once('skipif.inc'); ?>
+--FILE--
+<?php
+var_dump(is_callable("dl"));
+--EXPECT--
+bool(true)
